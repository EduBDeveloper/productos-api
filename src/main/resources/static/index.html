<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Productos</title>
    <!-- Bootstrap & Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Sidebar & AdminLTE-like styles -->
    <style>
        body {
            min-height: 100vh;
            display: flex;
            margin: 0;
        }
        
        #sidebar {
            width: 240px;
            background: #343a40;
            color: #fff;
        }
        
        #sidebar .nav-link {
            color: #adb5bd;
        }
        
        #sidebar .nav-link.active {
            background: #495057;
            color: #fff;
        }
        
        #sidebar .nav-link:hover {
            background: #495057;
            color: #fff;
        }
        
        #sidebar .brand-link {
            padding: 1rem;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
        }
        
        #sidebar .brand-link i {
            margin-right: 0.5rem;
        }
        
        #content {
            flex: 1;
            padding: 1rem;
            background: #f4f6f9;
            overflow-y: auto;
        }
        
        .card {
            margin-bottom: 1rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, .075);
        }
        
        .navbar {
            padding: 0.5rem 1rem;
            background: #fff;
            border-bottom: 1px solid #dee2e6;
        }
        
        .dashboard-icon {
            font-size: 2.5rem;
            opacity: .75;
        }
    </style>
</head>
<!-- Sidebar -->
<style>
    #sidebar {
        width: 260px;
        background: #343a40;
        color: #fff;
    }
    
    #sidebar .brand-link,
    #sidebar .user-panel,
    #sidebar .search-form {
        border-bottom: 1px solid #4b545c;
    }
    
    #sidebar .brand-link {
        justify-content: center;
        flex-direction: column;
        text-align: center;
    }
    
    #sidebar .brand-link img {
        max-width: 80%;
        height: auto;
        margin-bottom: 10px;
    }
    
    #sidebar .brand-link span {
        font-size: 1.25rem;
        font-weight: bold;
    }
    
    #sidebar .user-panel img {
        border-radius: 50%;
    }
    
    #sidebar .nav-header {
        padding: .5rem 1rem;
        font-size: .75rem;
        text-transform: uppercase;
        color: #ced4da;
    }
    
    #sidebar .nav-link {
        color: #adb5bd;
    }
    
    #sidebar .nav-link.active,
    #sidebar .nav-link:hover {
        background: #495057;
        color: #fff;
    }
    
    #sidebar .search-form input {
        background: #495057;
        border: none;
        color: #fff;
    }
    
    #sidebar .search-form button {
        background: #6c757d;
        border: none;
    }
</style>

<nav id="sidebar" class="d-flex flex-column p-0">
    <!-- Brand Logo -->
    <a href="#" class="brand-link d-flex align-items-center p-3 text-white text-decoration-none">
        <img src="/imagenes/logo.png" alt="Logo">
        <span>Test CRUD RestFul</span>
    </a>

    <!-- User Panel -->
    <div class="user-panel d-flex align-items-center p-3 text-white">
        <img src="/imagenes/foto.jpg" alt="User" width="40" height="40" class="me-3">
        <div>
            <p class="mb-0">Pablo</p>
            <small class="text-success"><i class="fas fa-circle"></i> Online</small>
        </div>
    </div>

    <!-- Search Form -->
    <div class="p-3 search-form">
        <form class="d-flex">
            <input class="form-control form-control-sm me-2" type="search" placeholder="Buscar..." aria-label="Search">
            <button class="btn btn-sm text-white" type="submit"><i class="fas fa-search"></i></button>
        </form>
    </div>

    <!-- Navigation -->
    <ul class="nav nav-pills flex-column mb-auto">
        <li class="nav-header">Principal</li>
        <li class="nav-item">
            <a href="#" class="nav-link active"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</a>
        </li>
        <li class="nav-item">
            <a href="#form-section" class="nav-link"><i class="fas fa-edit me-2"></i>Formulario</a>
        </li>
        <li class="nav-item">
            <a href="#table-section" class="nav-link"><i class="fas fa-table me-2"></i>Listado</a>
        </li>
        <li class="nav-header mt-3">Reportes</li>
        <li class="nav-item">
            <a href="#dashboard" class="nav-link"><i class="fas fa-chart-line me-2"></i>Métricas</a>
        </li>
        <li class="nav-item">
            <a href="#" class="nav-link"><i class="fas fa-file-export me-2"></i>Exportar</a>
        </li>
    </ul>
</nav>


<!-- Content Wrapper -->
<div id="content" class="p-4 bg-light min-vh-100">
    <!-- Top Navbar -->
    <header class="mb-4 d-flex justify-content-between align-items-center">
        <h2 class="fw-bold text-primary"><i class="fas fa-boxes me-2"></i>Gestión de Productos</h2>
    </header>

    <!-- Dashboard Cards -->
    <section id="dashboard" class="mb-5">
        <div class="row g-4">
            <div class="col-md-4">
                <div class="card bg-primary text-white shadow rounded-4">
                    <div class="card-body text-center">
                        <i class="fas fa-box fa-2x mb-2"></i>
                        <h6>Total Productos</h6>
                        <h3 id="totalProductos">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-danger text-white shadow rounded-4">
                    <div class="card-body text-center">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <h6>Stock Bajo</h6>
                        <h3 id="stockBajo">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-success text-white shadow rounded-4">
                    <div class="card-body text-center">
                        <i class="fas fa-coins fa-2x mb-2"></i>
                        <h6>Valor Inventario</h6>
                        <h3 id="valorInventario">0</h3>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Form -->
    <section id="form-section" class="card shadow rounded-4 border-0 mb-4">
        <div class="card-header bg-primary text-white rounded-top-4">
            <i class="fas fa-edit me-2"></i>Formulario de Producto
        </div>
        <div class="card-body bg-white rounded-bottom-4">
            <form id="productoForm" class="row g-3">
                <input type="hidden" id="productoId">
                <div class="col-md-4">
                    <label for="nombre" class="form-label">Nombre</label>
                    <input type="text" id="nombre" class="form-control rounded-pill" required>
                </div>
                <div class="col-md-4">
                    <label for="precio" class="form-label">Precio</label>
                    <input type="text" step="0.01" id="precio" class="form-control rounded-pill" required>
                </div>
                <div class="col-md-4">
                    <label for="stock" class="form-label">Stock</label>
                    <input type="number" id="stock" class="form-control rounded-pill" required>
                </div>
                <div class="col-12 mt-3">
                    <button type="submit" class="btn btn-success rounded-pill px-4">
                        <i class="fas fa-save me-1"></i> Guardar
                    </button>
                    <button type="button" class="btn btn-secondary rounded-pill px-4 ms-2" id="btnCancelar" style="display:none;">
                        <i class="fas fa-times me-1"></i> Cancelar
                    </button>
                </div>
            </form>
            <p id="mensaje" class="mt-3 fw-semibold"></p>
        </div>
    </section>

    <!-- Tabla de Productos -->
    <section id="table-section" class="card shadow rounded-4 border-0">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
            <div><i class="fas fa-table me-1"></i> Listado de Productos</div>
            <div class="input-group input-group-sm" style="width: 200px;">
                <input type="number" id="buscarId" class="form-control" placeholder="Buscar por ID">
                <button class="btn btn-dark" onclick="buscarPorId()"><i class="fas fa-search"></i></button>
            </div>
        </div>
        <div class="card-body">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Precio</th>
                        <th>Stock</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaProductos"></tbody>
            </table>
            <nav>
                <ul class="pagination justify-content-center" id="paginacion"></ul>
            </nav>
        </div>
    </section>
</div>


<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const apiBase = 'http://localhost:8080/api/productos';
    let editMode = false;
    let productosGlobal = [];
    let paginaActual = 1;
    const filasPorPagina = 5;

    function formatPrice(value) {
        return new Intl.NumberFormat('es-PY', {
            style: 'decimal',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(value);
    }

    async function cargarProductos() {
        const res = await fetch(apiBase);
        productosGlobal = await res.json();
        renderTabla();
        actualizarMetricas();
    }

    function renderTabla() {
        const tbody = document.getElementById('tablaProductos');
        tbody.innerHTML = '';
        const inicio = (paginaActual - 1) * filasPorPagina;
        const paginados = productosGlobal.slice(inicio, inicio + filasPorPagina);
        paginados.forEach(p => {
            tbody.innerHTML += `
                <tr>
                    <td>${p.id}</td>
                    <td>${p.nombre}</td>
                    <td>${formatPrice(p.precio)}</td>
                    <td>${p.stock}</td>
                    <td>
                        <button class="btn btn-sm btn-warning me-1" onclick="editarProducto(${p.id})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="eliminarProducto(${p.id})"><i class="fas fa-trash-alt"></i></button>
                    </td>
                </tr>`;
        });
        renderPaginacion();
    }

    function renderPaginacion() {
        const totalPaginas = Math.ceil(productosGlobal.length / filasPorPagina);
        const pag = document.getElementById('paginacion');
        pag.innerHTML = '';
        for (let i = 1; i <= totalPaginas; i++) {
            pag.innerHTML += `<li class="page-item ${i === paginaActual ? 'active' : ''}"><a class="page-link" href="#" onclick="cambiarPagina(${i})">${i}</a></li>`;
        }
    }

    function cambiarPagina(n) {
        paginaActual = n;
        renderTabla();
    }

    function actualizarMetricas() {
        const total = productosGlobal.length;
        const bajo = productosGlobal.filter(p => p.stock < 5).length;
        const valor = productosGlobal.reduce((sum, p) => sum + (p.precio * p.stock), 0);
        document.getElementById('totalProductos').textContent = total;
        document.getElementById('stockBajo').textContent = bajo;
        document.getElementById('valorInventario').textContent = formatPrice(valor);
    }

    document.getElementById('productoForm').addEventListener('submit', async e => {
        e.preventDefault();

        const id = document.getElementById('productoId').value;

        // Tomar el valor del input precio y eliminar los puntos (miles)
        const precioTexto = document.getElementById('precio').value.replace(/\./g, '').replace(',', '.');
        const precio = parseFloat(precioTexto);

        const data = {
            nombre: document.getElementById('nombre').value.trim(),
            precio: precio,
            stock: parseInt(document.getElementById('stock').value, 10)
        };

        let url = apiBase;
        let method = 'POST';
        if (editMode) {
            url += `/${id}`;
            method = 'PUT';
        }

        const mensajeElem = document.getElementById('mensaje');
        mensajeElem.textContent = '';
        mensajeElem.className = '';

        try {
            const res = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const payload = await res.json();

            if (res.ok) {
                mensajeElem.textContent = editMode ?
                    '✅ Producto actualizado.' :
                    '✅ Producto creado.';
                mensajeElem.className = 'text-success';
                resetForm();
                cargarProductos();
            } else {
                const texto = payload.error ?
                    payload.error :
                    Object.values(payload).join(' | ');
                mensajeElem.textContent = `❌ ${texto}`;
                mensajeElem.className = 'text-danger';
            }
        } catch (err) {
            console.error('Error de conexión o JS:', err);
        }
    });





    async function editarProducto(id) {
        const res = await fetch(`${apiBase}/${id}`);
        if (!res.ok) return;
        const p = await res.json();

        document.getElementById('productoId').value = p.id;
        document.getElementById('nombre').value = p.nombre;

        // Formatear precio con separadores de miles para mostrarlo bonito
        document.getElementById('precio').value = new Intl.NumberFormat('es-PY', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 2
        }).format(p.precio);

        document.getElementById('stock').value = p.stock;
        editMode = true;
        document.getElementById('btnGuardar').textContent = 'Actualizar';
        document.getElementById('btnCancelar').style.display = 'inline-block';
    }


    document.getElementById('btnCancelar').addEventListener('click', resetForm);

    function resetForm() {
        editMode = false;
        document.getElementById('productoForm').reset();
        document.getElementById('productoId').value = '';
        document.getElementById('btnGuardar').textContent = 'Guardar';
        document.getElementById('btnCancelar').style.display = 'none';
        document.getElementById('mensaje').textContent = '';
    }

    async function eliminarProducto(id) {
        if (!confirm('¿Seguro que deseas eliminar este producto?')) return;
        const res = await fetch(`${apiBase}/${id}`, {
            method: 'DELETE'
        });
        if (res.ok) cargarProductos();
        else alert('Error al eliminar');
    }

    async function buscarPorId() {
        const id = document.getElementById('buscarId').value;
        if (!id) return cargarProductos();
        const res = await fetch(`${apiBase}/${id}`);
        if (!res.ok) return alert('Producto no encontrado');
        const p = await res.json();
        productosGlobal = [p];
        paginaActual = 1;
        renderTabla();
    }

    document.addEventListener('DOMContentLoaded', cargarProductos);
</script>
</body>

</html>